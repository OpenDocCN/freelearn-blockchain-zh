# 区块链的组成部分和结构

区块链不是单一技术，而是更多的一种技术。区块链是一种架构概念，有许多构建区块链的方法，每种变体都会对系统运行产生不同的影响。在本章中，我们将讨论所有或大部分目前实施的区块链技术的方面。

在本章结束时，您应该能够描述区块链的各个部分，并在架构层面上评估一种区块链技术对另一种的能力。

以下是我们将要覆盖的概念：

+   区块

+   区块之间的链

+   哈希和签名

+   区块结构

+   区块矿工

+   区块验证者

+   智能合约

+   区块链速度

# 区块

区块链是一种特定的技术，但有许多形式和变种。例如，比特币和以太坊是工作量证明的区块链。以太坊有智能合约，并且许多区块链允许自定义代币。区块链可以通过它们的共识算法（PoS、PoW 和其他）来区分，*在第七章*——*达成共识*中有所涵盖*，*以及它们的功能集，比如能够运行智能合约以及这些智能合约在实践中的运作方式。所有这些变体都有一个共同的概念：区块。区块链技术的最基本单位是区块。想象一个基本的电子表格，可以简单地将区块视为其。在这个电子表格中，您可能会看到这样的条目：

| **账户** | **交易额** | **新余额** | **旧余额** | **操作** |
| --- | --- | --- | --- | --- |
| 账号-9234222 | −$2,000 | $5,000 | $7,000 | 向账号-12345678 发送资金 |
| 账号-12345678 | $2,000 | $2,000 | 0 | 从账号-9234222 接收资金 |
| 账号-3456789 | -$200 | $50 | $250 | 向账号-68890234 发送资金 |
| 账号-68890234 | $200 | $800 | $600 | 从账号-3456789 接收资金 |

一个区块是区块链网络中的交易条目集，存储在充当参与者的计算机上。每个区块链网络都有一个区块时间，或者每个区块表示交易的大致时间，以及一个区块大小：无论如何，一个区块可以处理的总交易量。如果一个网络的区块时间为两分钟，那两分钟内只有四笔交易，那么该区块就只包含这四笔交易。如果一个网络有 1,000,000 笔交易，那么可能有太多交易无法适应区块大小。在这种情况下，交易必须等待它们的轮次，等待一个有剩余空间的空区块。一些区块链通过网络费的概念解决了这个问题。网络费是发送者愿意支付的金额（以区块链的原生代币计量），以便将交易纳入一个区块中。费用越高，优先级越高，可以立即被纳入链中。

# 区块之间的链

除了交易分类帐，每个块通常还包含一些附加元数据。元数据包括以下内容：

+   对先前区块的引用

+   网络的元数据

+   交易的默克尔根，作为块有效性的检查

这些基础知识通常适用于所有的区块链。以太坊、比特币、莱特币等都使用这种常见模式，而这种模式也是链的本质。每个链还倾向于包含特定于该生态系统的其他元数据，这些差异将在以后的章节中讨论。以下是比特币区块链的一个示例：

<q>![](img/199339c2-4243-40d6-84fa-fffb944fe776.png)</q>

作者：中本聪，http://Bitcoin.org/Bitcoin.pdf，麻省理工学院，https://commons.wikimedia.org/w/index.php?curid=24542868

如果你问，Merkle 根是什么？那就引出了我们下一组关键概念：哈希和签名。

# 哈希和签名

假设你有两个各 50 页长的文本文件。你想知道它们是否相同或不同。你可以使用哈希值来实现这一点。哈希（或哈希函数）是一种数学过程，它将任何输入转换为固定长度的输出。有许多这样的函数，最常见的是 SHA-1、SHA-2 和 MD5。例如，以下是一个名为**MD5**的哈希函数的输出，输入是两页文本：

```
9a137a78cf0c364e4d94078af1e221be
```

哈希函数的强大之处在于当我在末尾添加一个字符并运行相同的函数时会发生什么：

```
8469c950d50b3394a30df3e0d2d14d74
```

如你所见，输出完全不同。如果你想快速证明某些数据在任何方面都没有被改变，哈希函数就能胜任。在我们的讨论中，哈希函数的重要部分如下：

+   计算机运行速度非常快。

+   这个函数是单向的。你可以轻松地获得哈希值，但实际上你不能使用哈希值来恢复原始数据。

+   它们可以被递归使用。例如，我可以取哈希的哈希；例如，MD5(`8469c950d50b3394a30df3e0d2d14d74`)变成了`705b003fc9b09ecbeac0b852dfc65377`。

哈希的递归性质使我们引入了**默克尔树**的概念，这个概念是以专利命名的。默克尔树是一种数据结构，如果你在白板上画出它，它往往像一棵树。在树的每一步中，根节点包含其子节点数据的哈希值。以下是默克尔树的图示：

![](img/df4e2d61-c322-4b57-8201-82c3bcd31d8f.png)

原始插图作者为 David Göthberg，瑞典，已释放至公共领域

在区块链中，这意味着存在着一个递归的哈希过程。递归哈希是指我们对哈希值进行哈希运算的过程。例如，想象一下我们有以下单词及其哈希值。这里，我们将使用 MD5 算法，因为在网络上很容易找到 MD5 哈希代码，所以你可以自己尝试一下：

```
Salad: c2e055acd7ea39b9762acfa672a74136
Fork: b2fcb4ba898f479790076dbd5daa133f
Spoon: 4b8e23084e0f4d55a47102da363ef90c
```

要计算递归哈希或根哈希，我们将把这些哈希值相加，如下所示：

```
c2e055acd7ea39b9762acfa672a74136b2fcb4ba898f479790076dbd5daa133f4b8e23084e0f4d55a47102da363ef90c
```

然后我们将对该值进行哈希，结果如下：

```
189d3992be73a5eceb9c6f7cc1ec66e1
```

这个过程可以一次又一次地发生。最终的哈希可以用来检查树中的任何值是否已更改。这个根哈希是一种数据高效且有效的方式，可以确保数据的一致性。

每个区块都包含了所有交易的根哈希。由于哈希的单向性，任何人都可以查看这个根哈希，并将其与区块中的数据进行比对，并知道所有数据是否有效和未更改。这使得任何人都可以快速验证每笔交易是否正确。每个区块链对这种模式都有小的变化（使用不同的函数或以稍微不同的方式存储数据），但基本概念是一样的。

# 数字签名

现在我们已经介绍了哈希，是时候来介绍一个相关的概念：**数字签名**。数字签名利用哈希的性质，不仅证明数据没有改变，还提供了谁创建了数据的保证。数字签名利用哈希的概念，还添加了一个新的概念：**数字密钥**。

# 数字密钥是什么？

所有常见的数字签名方法都使用所谓的**公钥密码学**。在公钥密码学中，有两把密钥：一个公钥和一个私钥。为了创建签名，首先对原始数据进行哈希，然后使用私钥对该哈希进行加密。加密后的哈希，以及其他信息，如用于加密的方法，都被附加到原始数据中，形成签名。

这就是公钥发挥作用的地方。公钥和私钥之间的数学连接允许公钥解密哈希，然后可以用哈希来检查数据。因此，现在可以检查两件事情：谁签署了数据以及被签名的数据是否已被更改。以下是同样的图解表示：

![](img/1791aa48-bbb4-402b-8f43-f67a04840dcd.png)

由 Engelbert Niehaus 制作，用户 Bananenfalter 制作的 SVG 色彩方案 - 使用 Bananenfalter 制作的插图的 SVG 颜色，并使用 Inkscape 进行编辑，CC BY-SA 3.0，https://en.wikiversity.org/w/index.php?curid=226250

这种密码学形式对区块链技术至关重要。通过哈希和数字签名，区块链能够记录行为（代币的移动）以及证明是谁发起了这些行为（通过数字签名）。

让我们举个例子，Jeremy 和 Nadia 希望互相安全地发送消息。每个人都公布了一个公钥。Jeremy 的公钥将如下所示（使用 1,024 位的 RSA 算法）：

```
-----BEGIN PUBLIC KEY-----
MIGeMA0GCSqGSIb3DQEBAQUAA4GMADCBiAKBgH+CYOAgKsHTrMlsaZ32Gpdfo4pw
JRfHu5d+KoOgbmYb0C2y1PiHNGEyXgd0a8iO1KWvzwRUMkPJr7DbVBnfl1YfucNp
OjAsUWT1pq+OVQ599zecpnUpyaLyg/aW9ibjWAGiRDVXemj0UgMUVNHmi+OEuHVQ
ccy5eYVGzz5RYaovAgMBAAE=
-----END PUBLIC KEY-----
```

有了这把密钥，他将保持私有另一把密钥，其外观如下：

```
-----BEGIN RSA PRIVATE KEY-----
MIICWwIBAAKBgH+CYOAgKsHTrMlsaZ32Gpdfo4pwJRfHu5d+KoOgbmYb0C2y1PiH
NGEyXgd0a8iO1KWvzwRUMkPJr7DbVBnfl1YfucNpOjAsUWT1pq+OVQ599zecpnUp
yaLyg/aW9ibjWAGiRDVXemj0UgMUVNHmi+OEuHVQccy5eYVGzz5RYaovAgMBAAEC
gYBR4AQYpk8OOr9+bxC6j2avwIegwzXuOSBpvGfMMV3yTvW0AlriYt7tcowSOV1k
YOKGqYdCflXwVTdtVsh//KSNiFtsLih2FRC+Uj1fEu2zpGzErhFCN2sv1t+2wjlk
TRY78prPNa+3K2Ld3NJse3gmhodYqRkxFFxlCmOxTzc4wQJBAOQ0PtsKCZwxRsyx
GAtULHWFIhV9o0k/DjLw5rreA8H3lb3tYZ5ErYuhS0HlI+7mrPUqzYaltG6QpJQY
YlMgktECQQCPClB1xxoIvccmWGoEvqG07kZ4OBZcBmgCzF6ULQY4JkU4k7LCxG4q
+wAeWteaP+/3HgS9RDQlHGITAmqhW6z/AkBaB16QzYnzC+GxmWAx//g2ONq0fcdw
eybf4/gy2qnC2SlDL6ZmaRPKVUy6Z2rgsjKj2koRB8iCIiA7qM8Jmn0xAkBzi9Vr
DqaNISBabVlW89cUnNX4Dvag59vlRsmv0J8RhHiuN0FT6/FCbvetjZxUUgm6CVmy
ugGVaNQgnvcb2T5pAkEAsSvEW6yq6KaV9NxXn4Ge4b9lQoGlR6xNrvGfoxto79vL
7nR29ZB4yVFo/kMVstU3uQDB0Pnj2fOUmI3MeoHgJg==
-----END RSA PRIVATE KEY-----
```

与此同时，娜迪亚将采取相同的步骤，得到以下两个密钥：

```
-----BEGIN PUBLIC KEY-----
MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDHWwgTfI5Tic41YjUZqTmiKt+R
s5OMKIEdHPTyM8FZNaOBWIosFQbYk266V+R7k9odTnwCfi370GOt0k5MdTQilb9h
bK/lYiavIltgBd+1Em7xm7UihwO4th5APcg2vG4sppK41b1a9/I5E6P/jpQ320vF
BMuEtcnBoWawWcbXJwIDAQAB
-----END PUBLIC KEY-----
```

这是她的私钥：

```
-----BEGIN RSA PRIVATE KEY-----
MIICXQIBAAKBgQDHWwgTfI5Tic41YjUZqTmiKt+Rs5OMKIEdHPTyM8FZNaOBWIos
FQbYk266V+R7k9odTnwCfi370GOt0k5MdTQilb9hbK/lYiavIltgBd+1Em7xm7Ui
hwO4th5APcg2vG4sppK41b1a9/I5E6P/jpQ320vFBMuEtcnBoWawWcbXJwIDAQAB
AoGBAKz9FCv8qHBbI2H1f0huLQHInEoNftpfh3Jg3ziQqpWj0ub5kqSf9lnWzX3L
qQuHB/zoTvnGzlY1xVlfJex4w6w49Muq2Ggdq23CnSoor8ovgmdUhtikfC6HnXwy
PG6rtoUYRBV3j8vRlSo5PtSRD+H4lt2YGhQoXQemwlw+r5pRAkEA+unxBOj7/sec
3Z998qLWw2wV4p9L/wCCfq5neFndjRfVHfDtVrYKOfVuTO1a8gOal2Tz/QI6YMpJ
exo9OEbleQJBAMtlimh4S95mxGHPVwWvCtmxaFR4RxUpAcYtX3R+ko1kbZ+4Q3Jd
TYD5JGaVBGDodBCRAJALwBv1J/o/BYIhmZ8CQBdtVlKWCkk8i/npVVIdQB4Y7mYt
Z2QUwRpg4EpNYbE1w3E7OH27G3NT5guKsc4c5gcyptE9rwOwf3Hd/k9N10kCQQCV
YsCjNidS81utEuGxVPy9IqWj1KswiWu6KD0BjK0KmAZD1swCxTBVV6c6iJwsqM4G
FNm68kZowkhYbc0X5KG1AkBp3Rqc46WBbpE5lj7nzhagYz5Cb/SbNLSp5AFh3W5c
sjsmYQXfVtw9YuU6dupFU4ysGgLBpvkf0iU4xtGOFvQJ
-----END RSA PRIVATE KEY-----
```

有了这些密钥，杰里米决定给娜迪亚发送一条消息。他使用她的密钥并加密以下消息：我爱比特币，结果如下所示的数据：

```
EltHy0s1W1mZi4+Ypccur94pDRHw6GHYnwC+cDgQwa9xB3EggNGHfWBM8mCIOUV3iT1uIzD5dHJwSqLFQOPaHJCSp2/WTSXmWLohm5EAyMOwKv7M4gP3D/914dOBdpZyrsc6+aD/hVqRZfOQq6/6ctP5/3gX7GHrgqbrq/L7FFc=
```

除了娜迪亚以外，没有人能读到这个。她使用相同的算法，输入这些数据和她的私钥，得到以下消息：

```
I love Bitcoin.
```

我们将在第四章中讨论更多关于这个话题的内容，*密码学和区块链背后的机制*。

# 示例区块数据

在本节中，我们将研究区块链中使用的数据结构。我们主要将关注以太坊、比特币和比特股区块链，以查看关键的共同点和不同点。

# 示例以太坊区块

这是来自示例以太坊区块的数据，来自区块 5223669：

![](img/3342bee8-b861-4fa4-9cbf-dbf3770391a4.png)

如果你记得，在本章的开头，我们说有三件事是区块链的共同点：对先前区块的引用，区块中交易的哈希值，以及特定于网络的元数据。在这个来自以太坊网络的区块中，这三者都存在。对先前区块的引用包含在区块高度和父哈希值中。交易的哈希值是哈希条目，元数据是其他所有内容，这将是网络特定的。

# 比特币区块

这是比特币区块的快照：

![](img/2a8fa709-5352-4f7f-8eef-c56778354fa6.png)

比特币和以太坊都是 PoW 链；现在让我们来看一个**股权证明**（**POS**）生态系统：比特股。

这是来自比特股区块的一些数据：

![](img/187c4dd7-4ba9-4838-9af7-52fd3fc03399.png)

尽管架构完全不同，但基本原理仍然存在：对先前区块的引用，默克尔根和网络元数据。在比特股中，您还可以看到有一个见证签名。作为 PoS 区块链，比特股有验证者（它们被称为见证人）。在这里，我们看到负责计算此区块的计算机的见证和签名。

# 全局状态

区块链技术的一个关键特性是它可以作为一个可信任的全局状态。有许多应用场景中，可信任的全局状态是重要但困难的，比如金融技术和物流。

例如，几年前，我在线订购了一些摄像机设备。几天后，我回家时惊讶地发现我的设备已经到货了。我非常感激，因为那些昂贵的设备没有被偷走。直到第二天我才收到卖家发来的一封邮件，提醒我包裹已经发出。

这里清晰地列出了全局状态的细节。事实上，摄像机已经在一辆卡车上了，但我和货运商都没有妥善地存储这些信息。如果我的摄像机设备从我门口被盗走了，那将会很难发现发生了什么。

如果卖方、物流公司和我都从区块链中写入和读取数据，这将是不可能的。当物流公司登记货物时，物体的状态会发生变化，一旦下一个区块被确认，卖方和我都会立即知道。

# 区块时间和区块大小

正如之前讨论的，每个区块链都有一个**区块时间**和一个**区块大小**。每个网络可能具有非常不同的值和处理区块时间的方式。例如，在比特币中，区块时间是 10 分钟，而在以太坊中，区块时间是 20 秒。在恒星网络中，区块时间约为 4 秒。这些区块时间是由运行网络的代码确定的。对于比特币、莱特币和以太坊等网络，区块时间实际上是一个平均值。因为这些是 PoW 网络，一旦矿工解决了挖矿难题，他们就可以证明该区块已完成。在这些网络中，难题的难度会自动调整，以便平均达到所需的区块时间。

区块大小是每个区块中可以存储的最大信息量。对于比特币来说，这是价值 1 MB 的交易数据。对于以太坊来说，限制实际上是以 GAS 为单位衡量的，GAS 是一种特殊的计量单位，用于衡量处理能力（因为以太坊具有智能合约）以及存储。与比特币不同，每个区块的 GAS/存储限制不是固定的，而是由矿工动态调整的。

需要注意的是，区块中只包含可能的信息，直到被网络确认为止。例如，可能会发生 1000 笔交易，但如果只有 500 笔被记录在下一个区块中，那么只有这 500 笔交易是真实的。剩余的交易将继续等待被包含到未来的区块中。

# 区块链矿工

区块链矿工和区块链验证者（见下面的部分）都与共识有关，这将在第七章 *实现共识* 中深入探讨。通常，区块链矿工与区块链相关联。PoW 链通过让矿工的计算机竞争执行证明链中的区块所需的工作来运作。目前，唯一主要的 PoW 区块链是比特币、莱特币和以太坊。大多数其他系统使用 PoS 共识的变体，我们将在下一节 *区块链验证者* 中讨论。我们将在第十八章 *挖矿* 中详细介绍挖矿的工作原理。

# 区块链验证者

**区块链验证者**被 PoS 系统使用。 PoS 系统通过要求希望参与网络的计算机拥有**股份**（大量代币）来帮助区块链运作。与 PoW 算法不同，计算机不能加入网络并期望在共识中发挥任何作用。相反，他们必须通过代币所有权来*购入*。根据网络的不同，验证者的命名约定可能不同。Tendermint 有验证者，Steemit 和 Bitshares 有见证人，Cardano 有股东等。验证者是允许参与网络并这样做的具有正股份（代币数量）的计算机。每个链都有自己的规则来解决这个问题，这将在第七章*，* *实现共识*中更加深入地讨论。

# 智能合约

一些区块链被称为具有智能合约，当它们能够根据链的变化执行操作和行为时。这将在第十四章 *智能合约*和第十七章 *去中心化应用程序*中深入讨论。

# 区块链速度

区块链系统的一个持续关注点是性能。公共区块链是全球性系统，其系统资源同时由全球所有用户共享。由于用户基数庞大，资源约束是一个真正的问题，并且已经导致了真正的问题。例如，一个名为**CryptoKitties**的热门游戏在以太坊上推出，导致网络拥塞。其他应用程序几乎无法使用，因为来自 CryptoKitties 的负载使网络不堪重负。

# 如何计算区块链吞吐量

计算区块链吞吐量的快速粗略方法如下：

![](img/d5892ee8-b811-4417-a09c-99b1c95d2fe7.png)![](img/802d8f75-b8d2-48ca-a2bf-f288b223f05e.png)![](img/4b210f00-be00-4e25-a3d2-a4670259a99c.png)

对于比特币，交易吞吐量约为*7tx/second*。这是因为区块相对较小，而且区块时间非常长。以太坊具有较短的区块时间，但区块非常小，因此最终达到约*14tx/second*。像 Stellar、Bitshares 和 Waves 这样的区块链可以达到每秒超过*1000tx/second*的速度。

# 与传统网络的比较

VISA 是全球首要的支付处理网络。在公司的一篇博客中，透露 VISA 每秒可以处理超过 40,000 笔交易。这是峰值容量，除了在诸如圣诞节之类的时候，它通常不会处理这么多交易。然而，应清楚地看到，区块链在能够与 VISA 相媲美的规模上处理全球支付之前还有很长的路要走。然而，像 EOS 和 COSMOS 这样的新网络正在尝试，通过创新的多线程设计和分段区块链区域。

# 摘要

现在你应该理解了区块链的基本组成部分。区块是一组被聚合在一起的交易，并充当区块链的基本单位。在 PoW 区块链上，矿工是创建新区块的计算机。在 PoS 区块链上，验证者，也称为见证人和其他名称，是创建区块的计算机。数字签名由公钥和私钥组成，并利用数学来证明数据的作者。

哈希的关键思想是使用数学函数将任意数据映射到一个单一、易处理的值。对数据的任何更改都将使最终值大不相同。

+   从哈希值构造原始数据基本上是不可能的，但从原始数据创建哈希值却很容易。

+   你可以利用这些属性来证明数据未被更改。

在下一章中，我们将学习这些系统是什么，以及区块链如何同时具备这两种特性。我们将学习如何区分这两个系统，并且为什么这些概念对区块链如此重要。
